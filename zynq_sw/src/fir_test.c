/*
FPGA testbench for the FIR filter
noisy data is sent through the FIR and Filtered data is recived
Recived data is compared vs MATLAB outputted signal
this software uses the AXI stream FIFO driver in Polling mode  
*/
/***************************** Include Files *********************************/
#include "xparameters.h"
#include "xil_exception.h"
#include "xstreamer.h"
#include "xil_cache.h"
#include "xllfifo.h"
#include "xstatus.h"
#include "my_fir_filter.h"
#include <stdio.h>
#include "platform.h"
#include "xil_printf.h"
#include "sleep.h"

/**************************** Type Definitions *******************************/

/***************** Macros (Inline Functions) Definitions *********************/

#define TX_FIFO_DEV_ID	   	XPAR_AXI_FIFO_1_DEVICE_ID
#define RX_FIFO_DEV_ID		XPAR_AXI_FIFO_0_DEVICE_ID

#define WORD_SIZE 4			/* Size of words in bytes */

#define MAX_PACKET_LEN 4

#define NO_OF_PACKETS 128

#define MAX_DATA_BUFFER_SIZE NO_OF_PACKETS*MAX_PACKET_LEN

#define TX_BASE_ADDR 0x00A0003000
#define RX_BASE_ADDR 0x00A0001000
#undef DEBUG

/************************** Function Prototypes ******************************/
#ifdef XPAR_UARTNS550_0_BASEADDR
static void Uart550_Setup(void);
#endif

int TxSend(u32 BASE_ADDR ,u32  *SourceAddr);
int RxReceive(u32 BASE_ADDR, u32 *DestinationAddr);

/************************** Variable Definitions *****************************/
/*
 * Device instance definitions
 */
XLlFifo TXFifo ;
XLlFifo RXFifo ;



/*****************************************************************************/
/**
*
* Main function
*
* This function is the main entry of the Axi FIFO Polling test.
*
* @param	None
*
* @return
*		- XST_SUCCESS if tests pass
* 		- XST_FAILURE if fails.
*
* @note		None
*
******************************************************************************/
int main()
{
    init_platform();
	xil_printf("--- Entering main() ---\n\r");
	int Status ;


	//// init the filter & write then read & check the FIR coeffs 
	Status = 	my_fir_filter_init() ;
	if (Status!= XST_SUCCESS) {
		xil_printf("Filter init failure \n\r");
		return XST_FAILURE;
	}


	xil_printf("--- FIFO_INIT---\n\r");
/// Resetting TX ISR
	Xil_In32(TX_BASE_ADDR);
	Xil_Out32(TX_BASE_ADDR , 0xFFFFFFFF);
	Status = Xil_In32(TX_BASE_ADDR);
	if(Status != 0x0) {
		xil_printf("\n ERROR : Reset value of TX FIFO ISR0 : 0x%x\t"
					"Expected : 0x0\n\r",
					Xil_In32(TX_BASE_ADDR));
		return XST_FAILURE;
	}
/// Read the IER
	Xil_Out32(TX_BASE_ADDR + 0x4 , 0x00000000);
	Status = Xil_In32(TX_BASE_ADDR + 0x4);
	if(Status != 0x0) {
		xil_printf("\n ERROR : Reset value of TX FIFO IER0 : 0x%x\t"
					"Expected : 0x0\n\r",
					Xil_In32(TX_BASE_ADDR + 0x4));
		return XST_FAILURE;
	}


	/// Resetting TX ISR
		Xil_In32(RX_BASE_ADDR);
		Xil_Out32(RX_BASE_ADDR , 0xFFFFFFFF);
		Status = Xil_In32(RX_BASE_ADDR);
		if(Status != 0x0) {
			xil_printf("\n ERROR : Reset value of RX FIFO ISR0 : 0x%x\t"
						"Expected : 0x0\n\r",Xil_In32(RX_BASE_ADDR));
			return XST_FAILURE;
		}
	/// Read the IER
		Xil_Out32(RX_BASE_ADDR + 0x4 , 0x00000000);
		Status = Xil_In32(TX_BASE_ADDR + 0x4);
		if(Status != 0x0) {
			xil_printf("\n ERROR : Reset value of RX FIFO IER0 : 0x%x\t"
						"Expected : 0x0\n\r",
						Xil_In32(RX_BASE_ADDR + 0x4));
			return XST_FAILURE;
		}

// Read the TDFV
	Status = Xil_In32(TX_BASE_ADDR + 0xC);
	Status = Xil_In32(RX_BASE_ADDR + 0xC);

// Read the RDFO
	Status = Xil_In32(TX_BASE_ADDR + 0x1C);
	Status = Xil_In32(RX_BASE_ADDR + 0x1C);

//Enable transmit complete and receive complete interrupts
	Xil_Out32((TX_BASE_ADDR + 0x4) , 0x0C000000);
	Xil_Out32((RX_BASE_ADDR + 0x4) , 0x0C000000);

	u32 noisy_data[NO_OF_PACKETS * 4] = {0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a , 0x2141 , 0x2f05 , 0x2434 , 0x18c5 , 0x24af , 0x06cb , 0x1856 , 0x0048 , 0x0000 , 0xffb8 , 0xe7aa , 0xf935 , 0xdb51 , 0xe73b , 0xdbcc , 0xd0fb , 0xdebf , 0xc3e6 , 0xd9a1 , 0xc6d7 , 0xcccd , 0xd3a3 , 0xc376 , 0xdd7f , 0xc893 , 0xddc8 , 0xdbcc , 0xda6e , 0xf17c , 0xdf9b , 0xfdd5 , 0xf2eb , 0x0000 , 0x0d15 , 0x022b , 0x2065 , 0x0e84 , 0x2592 , 0x2434 , 0x2238 , 0x376d , 0x2281 , 0x3c8a , 0x2c5d , 0x3333 , 0x3929 , 0x265f , 0x3c1a } 	;
	u32 expected_filtered_data[NO_OF_PACKETS * 4] = {0x00000000 , 0xfffeffbc , 0xfffe3c73 , 0xfffb2d7e , 0xfff84c4e , 0xfff3dcf7 , 0xffef8991 , 0xffeccf77 , 0xffebab75 , 0xfff001e8 , 0xfff86a04 , 0x0006eba7 , 0x0018fcac , 0x002ae025 , 0x00391682 , 0x003b7117 , 0x002f1fb0 , 0x000f132a , 0xffdd40c1 , 0xffa07082 , 0xff63b08b , 0xff3ba8df , 0xff3c554e , 0xff7fbb6f , 0x001b19df , 0x011f0750 , 0x02959c63 , 0x047aaed3 , 0x06c3df61 , 0x0958277d , 0x0c199fd0 , 0x0ee52c4d , 0x1194fe45 , 0x1409d877 , 0x16252e7d , 0x17d43a4e , 0x190909ed , 0x19bd8feb , 0x19f38287 , 0x19ace74e , 0x18f30fe9 , 0x17cbe374 , 0x164080c0 , 0x14595231 , 0x121cf930 , 0x0f966a92 , 0x0cccab14 , 0x09cc785d , 0x06a0e8d0 , 0x0356ecad , 0xfffe3c73 , 0xfca3408c , 0xf957637e , 0xf627649a , 0xf322de7e , 0xf05664e5 , 0xedceb246 , 0xeb96afb6 , 0xe9b7e944 , 0xe83b0833 , 0xe725ecc3 , 0xe67df8d7 , 0xe64593fb , 0xe67de12b , 0xe72615c3 , 0xe83ad8db , 0xe9b81244 , 0xeb96980a , 0xedceb246 , 0xf0567c91 , 0xf322b57d , 0xf62793f2 , 0xf9573a7e , 0xfca4587d , 0x00000000 , 0x035ba783 , 0x06a8c582 , 0x09d86c0e , 0x0cdd4a83 , 0x0fa9836f , 0x12314dba , 0x146967f6 , 0x1647edbc , 0x17c52725 , 0x18d9ea3d , 0x19821ed5 , 0x19ba6c05 , 0x19820729 , 0x18da133d , 0x17c4f7cd , 0x164816bc , 0x1469504a , 0x12314dba , 0x0fa99b1b , 0x0cdd2182 , 0x09d89b66 , 0x06a89c82 , 0x035bbf2f , 0x00000000 , 0xfca440d1 , 0xf957637e , 0xf627649a , 0xf322de7e , 0xf05664e5 , 0xedceb246 , 0xeb96afb6 , 0xe9b7e944 , 0xe83b0833 , 0xe725ecc3 , 0xe67df8d7 , 0xe64593fb , 0xe67de12b , 0xe72615c3 , 0xe83ad8db , 0xe9b81244 , 0xeb96980a , 0xedceb246 , 0xf0567c91 , 0xf322b57d , 0xf62793f2 , 0xf9573a7e , 0xfca4587d , 0x00000000 , 0x035ba783 , 0x06a8c582 , 0x09d86c0e , 0x0cdd4a83 , 0x0fa9836f , 0x12314dba , 0x146967f6 , 0x1647edbc , 0x17c52725 , 0x18d9ea3d , 0x19821ed5 , 0x19ba6c05 , 0x19820729 , 0x18da133d , 0x17c4f7cd , 0x164816bc , 0x1469504a , 0x12314dba , 0x0fa99b1b , 0x0cdd2182 , 0x09d89b66 , 0x06a89c82 , 0x035bbf2f , 0x00000000 , 0xfca440d1 , 0xf957637e , 0xf627649a , 0xf322de7e , 0xf05664e5 , 0xedceb246 , 0xeb96afb6 , 0xe9b7e944 , 0xe83b0833 , 0xe725ecc3 , 0xe67df8d7 , 0xe64593fb , 0xe67de12b , 0xe72615c3 , 0xe83ad8db , 0xe9b81244 , 0xeb96980a , 0xedceb246 , 0xf0567c91 , 0xf322b57d , 0xf62793f2 , 0xf9573a7e , 0xfca4587d , 0x00000000 , 0x035ba783 , 0x06a8c582 , 0x09d86c0e , 0x0cdd4a83 , 0x0fa9836f , 0x12314dba , 0x146967f6 , 0x1647edbc , 0x17c52725 , 0x18d9ea3d , 0x19821ed5 , 0x19ba6c05 , 0x19820729 , 0x18da133d , 0x17c4f7cd , 0x164816bc , 0x1469504a , 0x12314dba , 0x0fa99b1b , 0x0cdd2182 , 0x09d89b66 , 0x06a89c82 , 0x035bbf2f , 0x00000000 , 0xfca440d1 , 0xf957637e , 0xf627649a , 0xf322de7e , 0xf05664e5 , 0xedceb246 , 0xeb96afb6 , 0xe9b7e944 , 0xe83b0833 , 0xe725ecc3 , 0xe67df8d7 , 0xe64593fb , 0xe67de12b , 0xe72615c3 , 0xe83ad8db , 0xe9b81244 , 0xeb96980a , 0xedceb246 , 0xf0567c91 , 0xf322b57d , 0xf62793f2 , 0xf9573a7e , 0xfca4587d , 0x00000000 , 0x035ba783 , 0x06a8c582 , 0x09d86c0e , 0x0cdd4a83 , 0x0fa9836f , 0x12314dba , 0x146967f6 , 0x1647edbc , 0x17c52725 , 0x18d9ea3d , 0x19821ed5 , 0x19ba6c05 , 0x19820729 , 0x18da133d , 0x17c4f7cd , 0x164816bc , 0x1469504a , 0x12314dba , 0x0fa99b1b , 0x0cdd2182 , 0x09d89b66 , 0x06a89c82 , 0x035bbf2f , 0x00000000 , 0xfca440d1 , 0xf957637e , 0xf627649a , 0xf322de7e , 0xf05664e5 , 0xedceb246 , 0xeb96afb6 , 0xe9b7e944 , 0xe83b0833 , 0xe725ecc3 , 0xe67df8d7 , 0xe64593fb , 0xe67de12b , 0xe72615c3 , 0xe83ad8db , 0xe9b81244 , 0xeb96980a , 0xedceb246 , 0xf0567c91 , 0xf322b57d , 0xf62793f2 , 0xf9573a7e , 0xfca4587d , 0x00000000 , 0x035ba783 , 0x06a8c582 , 0x09d86c0e , 0x0cdd4a83 , 0x0fa9836f , 0x12314dba , 0x146967f6 , 0x1647edbc , 0x17c52725 , 0x18d9ea3d , 0x19821ed5 , 0x19ba6c05 , 0x19820729 , 0x18da133d , 0x17c4f7cd , 0x164816bc , 0x1469504a , 0x12314dba , 0x0fa99b1b , 0x0cdd2182 , 0x09d89b66 , 0x06a89c82 , 0x035bbf2f , 0x00000000 , 0xfca440d1 , 0xf957637e , 0xf627649a , 0xf322de7e , 0xf05664e5 , 0xedceb246 , 0xeb96afb6 , 0xe9b7e944 , 0xe83b0833 , 0xe725ecc3 , 0xe67df8d7 , 0xe64593fb , 0xe67de12b , 0xe72615c3 , 0xe83ad8db , 0xe9b81244 , 0xeb96980a , 0xedceb246 , 0xf0567c91 , 0xf322b57d , 0xf62793f2 , 0xf9573a7e , 0xfca4587d , 0x00000000 , 0x035ba783 , 0x06a8c582 , 0x09d86c0e , 0x0cdd4a83 , 0x0fa9836f , 0x12314dba , 0x146967f6 , 0x1647edbc , 0x17c52725 , 0x18d9ea3d , 0x19821ed5 , 0x19ba6c05 , 0x19820729 , 0x18da133d , 0x17c4f7cd , 0x164816bc , 0x1469504a , 0x12314dba , 0x0fa99b1b , 0x0cdd2182 , 0x09d89b66 , 0x06a89c82 , 0x035bbf2f , 0x00000000 , 0xfca440d1 , 0xf957637e , 0xf627649a , 0xf322de7e , 0xf05664e5 , 0xedceb246 , 0xeb96afb6 , 0xe9b7e944 , 0xe83b0833 , 0xe725ecc3 , 0xe67df8d7 , 0xe64593fb , 0xe67de12b , 0xe72615c3 , 0xe83ad8db , 0xe9b81244 , 0xeb96980a , 0xedceb246 , 0xf0567c91 , 0xf322b57d , 0xf62793f2 , 0xf9573a7e , 0xfca4587d , 0x00000000 , 0x035ba783 , 0x06a8c582 , 0x09d86c0e , 0x0cdd4a83 , 0x0fa9836f , 0x12314dba , 0x146967f6 , 0x1647edbc , 0x17c52725 , 0x18d9ea3d , 0x19821ed5 , 0x19ba6c05 , 0x19820729 , 0x18da133d , 0x17c4f7cd , 0x164816bc , 0x1469504a , 0x12314dba , 0x0fa99b1b , 0x0cdd2182 , 0x09d89b66 , 0x06a89c82 , 0x035bbf2f , 0x00000000 , 0xfca440d1 , 0xf957637e , 0xf627649a , 0xf322de7e , 0xf05664e5 , 0xedceb246 , 0xeb96afb6 , 0xe9b7e944 , 0xe83b0833 , 0xe725ecc3 , 0xe67df8d7 , 0xe64593fb , 0xe67de12b , 0xe72615c3 , 0xe83ad8db , 0xe9b81244 , 0xeb96980a , 0xedceb246 , 0xf0567c91 , 0xf322b57d , 0xf62793f2 , 0xf9573a7e , 0xfca4587d , 0x00000000 , 0x035ba783 , 0x06a8c582 , 0x09d86c0e , 0x0cdd4a83 , 0x0fa9836f , 0x12314dba , 0x146967f6 , 0x1647edbc , 0x17c52725 , 0x18d9ea3d , 0x19821ed5 , 0x19ba6c05 , 0x19820729 , 0x18da133d , 0x17c4f7cd , 0x164816bc , 0x1469504a , 0x12314dba , 0x0fa99b1b , 0x0cdd2182 , 0x09d89b66 , 0x06a89c82 , 0x035bbf2f , 0x00000000 , 0xfca440d1 , 0xf957637e , 0xf627649a , 0xf322de7e , 0xf05664e5 , 0xedceb246 , 0xeb96afb6 , 0xe9b7e944 , 0xe83b0833 , 0xe725ecc3 , 0xe67df8d7 , 0xe64593fb , 0xe67de12b , 0xe72615c3 , 0xe83ad8db , 0xe9b81244 , 0xeb96980a , 0xedceb246 , 0xf0567c91 , 0xf322b57d , 0xf62793f2 , 0xf9573a7e , 0xfca4587d , 0x00000000 , 0x035ba783 , 0x06a8c582 , 0x09d86c0e , 0x0cdd4a83 , 0x0fa9836f , 0x12314dba , 0x146967f6 , 0x1647edbc , 0x17c52725 , 0x18d9ea3d , 0x19821ed5 , 0x19ba6c05 , 0x19820729 , 0x18da133d , 0x17c4f7cd , 0x164816bc , 0x1469504a , 0x12314dba , 0x0fa99b1b , 0x0cdd2182 , 0x09d89b66 , 0x06a89c82 , 0x035bbf2f , 0x00000000 , 0xfca440d1 , 0xf957637e , 0xf627649a , 0xf322de7e , 0xf05664e5 , 0xedceb246 , 0xeb96afb6 , 0xe9b7e944 , 0xe83b0833 , 0xe725ecc3 , 0xe67df8d7 , 0xe64593fb , 0xe67de12b , 0xe72615c3 , 0xe83ad8db , 0xe9b81244 , 0xeb96980a , 0xedceb246 , 0xf0567c91 , 0xf322b57d , 0xf62793f2 , 0xf9573a7e , 0xfca4587d , 0x00000000 , 0x035ba783 , 0x06a8c582 , 0x09d86c0e , 0x0cdd4a83 , 0x0fa9836f};
	u32 filtered_data [NO_OF_PACKETS * 4]  ;


	Status = TxSend(TX_BASE_ADDR,noisy_data);
	if (Status != XST_SUCCESS){
		xil_printf("Transmisson of Data failed\n\r");
		return XST_FAILURE;
	}

//// Send noisy Data
// Generate the Noisy data , and set up the buffers source and destination
// for now lets go with some DATA from a LUT until I make something based on DDS

	xil_printf("DATA TRANSMITION DONE \n\r");

	Status = RxReceive(RX_BASE_ADDR,filtered_data);
	if(Status != 0x0) {
		xil_printf("\n ERROR in RxRecive");
		return XST_FAILURE;
	}

	xil_printf("DONE READINF RX FIFO ... \n\r");
//// Self checking
	int Error = 0;

	/* Compare the expected vs received */
	xil_printf(" Comparing data... MATLAB vs HW\n\r");
	for(int i=53 ; i<MAX_DATA_BUFFER_SIZE - 53 ; i++ ){
	    if ( *(filtered_data + i)&0xFFF0000 != *(expected_filtered_data + i + 53)&0xFFF0000){
	        Error += 1;
	        printf("Mismatch found at index %d: expected %x, received %x \n\r", i, *(expected_filtered_data + i +53)&0xFFF0000, *(filtered_data + i)&0xFFF0000);
	    }
	}

	if (Error != 0){
		xil_printf("#############Filter Failed ###############\n\r");
		return XST_FAILURE;
	}
	xil_printf("#########################################################\n\r"
				"Filter Passed Successfully No Mismatches with MATLAB !! \n\r"
				"#########################################################\n\r"
	);
	xil_printf("--- Exiting main() ---\n\r");

	cleanup_platform();
	return XST_SUCCESS;
}


int TxSend(u32 BASE_ADDR ,u32  *SourceAddr)
{
    start_filter();
	int i;
	int j;
	xil_printf("Transmitting Data ... \r\n");

	/* Fill the transmit buffer with incremental pattern */
//	for (i=0;i<MAX_DATA_BUFFER_SIZE;i++)
//		*(SourceAddr + i) = i;

	for(i=0 ; i < NO_OF_PACKETS ; i++){

		/* Writing into the FIFO Transmit Port Buffer */
		for (j=0 ; j < MAX_PACKET_LEN ; j++){
			if (Xil_In32(TX_BASE_ADDR + 0xC)){
//				XLlFifo_TxPutWord(InstancePtr,
//					*(SourceAddr+(i*MAX_PACKET_LEN)+j));
				Xil_Out32((BASE_ADDR + 0x10) , Xil_In32(SourceAddr+(i*MAX_PACKET_LEN)+j));
			}
		}

	}

	/* Start Transmission by writing transmission length into the TLR */
	Xil_Out32((BASE_ADDR + 0x14), (NO_OF_PACKETS*4* WORD_SIZE));

	while( !(Xil_In32(BASE_ADDR) & 0x08000000)) {}

	/* Transmission Complete */
	return XST_SUCCESS;
}


int RxReceive (u32 BASE_ADDR, u32* DestinationAddr)
{

	int i	;
	int Status;
	Xil_Out32(BASE_ADDR , 0xFFFFFFFF);
	Status = Xil_In32(RX_BASE_ADDR);
	if(Status != 0x0) {
		xil_printf("\n ERROR : Reset value of RX FIFO ISR0 : 0x%x\t"
					"Expected : 0x0\n\r",
					Xil_In32(RX_BASE_ADDR));
		return XST_FAILURE;
	}


// Read the RDFO
	u32 RDFO = Xil_In32(BASE_ADDR + 0x1C);

	u32 RLR = Xil_In32(BASE_ADDR + 0x24);

	u32 RDR = Xil_In32(BASE_ADDR + 0x30);


	u32 RDFD = Xil_In32(BASE_ADDR + 0x20);



	xil_printf("Receiving Data ... \r\n");


	for(i = 0; i < NO_OF_PACKETS * MAX_PACKET_LEN - 1; i++) {
	    /* Read from the FIFO */
	    DestinationAddr[i] = Xil_In32(BASE_ADDR + 0x20);
	}
	return XST_SUCCESS;
}

